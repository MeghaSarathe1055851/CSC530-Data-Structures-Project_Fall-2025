{% extends "base.html" %}
{% block content %}

<h2 class="mb-4">Admin Dashboard</h2>

<!-- ================= ADMIN ANALYTICS CARDS ================ -->
<div class="row g-4 mb-4">

    <!-- Total Orders -->
    <div class="col-md-3">
        <a href="/admin/view_orders" class="text-decoration-none">
            <div class="card shadow-sm text-center p-3" style="cursor: pointer;">
                <i class="bi bi-receipt-cutoff text-primary" style="font-size: 2.5rem;"></i>
                <h5 class="mt-2">Total Orders</h5>
                <h3 class="text-dark">{{ total_orders }}</h3>
                <small class="text-muted">Click to view</small>
            </div>
        </a>
    </div>

    <!-- Revenue -->
    <div class="col-md-3">
        <a href="/admin/revenue_report" class="text-decoration-none">
            <div class="card shadow-sm text-center p-3" style="cursor: pointer;">
                <i class="bi bi-currency-dollar text-success" style="font-size: 2.5rem;"></i>
                <h5 class="mt-2">Revenue</h5>
                <h3 class="text-success">$ {{ "%.2f"|format(total_revenue) }}</h3>
                <small class="text-muted">Click to view report</small>
            </div>
        </a>
    </div>

    <!-- Top Product -->
    <div class="col-md-3">
        <a href="/admin/top_product" class="text-decoration-none">
            <div class="card shadow-sm text-center p-3" style="cursor: pointer;">
                <i class="bi bi-star-fill text-warning" style="font-size: 2.5rem;"></i>
                <h5 class="mt-2">Top Product</h5>
                <h6 class="fw-bold">{{ most_frequent[0] }}</h6>
                <small class="text-muted">{{ most_frequent[1] }} sold</small><br>
                <small class="text-muted">Click to view</small>
            </div>
        </a>
    </div>

    <!-- Out of Stock -->
    <div class="col-md-3">
        <a href="/admin/out_of_stock" class="text-decoration-none">
            <div class="card shadow-sm text-center p-3" style="cursor: pointer;">
                <i class="bi bi-x-circle text-danger" style="font-size: 2.5rem;"></i>
                <h5 class="mt-2">Out of Stock</h5>
                <h3 class="text-danger">{{ out_of_stock|length }}</h3>
                <small class="text-muted">Click to view</small>
            </div>
        </a>
    </div>

</div>

<hr>

<!-- ================= ADD PRODUCT FORM ================ -->
<h3 class="mt-4 mb-3">Add a New Product</h3>

<div class="card shadow-sm mb-5">
    <div class="card-body">

        <form method="POST" action="/admin/add_product">

            <div class="row g-3">

                <!-- Product Name -->
                <div class="col-md-4">
                    <label class="form-label">Product Name</label>
                    <input type="text" name="name"
                           class="form-control" required
                           oninput="autoSelectCategory()">
                </div>

                <!-- Category -->
                <div class="col-md-4">
                    <label class="form-label">Category</label>
                    <select name="category" id="category" class="form-select" required>
                        <option value="Appliances">Appliances</option>
                        <option value="Baby">Baby</option>
                        <option value="Beauty">Beauty</option>
                        <option value="Computers">Computers</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Furniture">Furniture</option>
                        <option value="Grocery & Household Essentials">Grocery & Household Essentials</option>
                        <option value="Health & Personal Care">Health & Personal Care</option>
                        <option value="Home & Kitchen">Home & Kitchen</option>
                        <option value="Home Improvement">Home Improvement</option>
                        <option value="Office Products">Office Products</option>
                        <option value="Patio, Lawn & Garden">Patio, Lawn & Garden</option>
                        <option value="Pet Supplies">Pet Supplies</option>
                        <option value="Sports & Fitness">Sports & Fitness</option>
                        <option value="Toys">Toys</option>
                    </select>
                </div>

                <!-- Price -->
                <div class="col-md-2">
                    <label class="form-label">Price ($)</label>
                    <input type="number" name="price" class="form-control"
                           min="0" step="0.01" required>
                </div>

                <!-- Quantity -->
                <div class="col-md-2">
                    <label class="form-label">Quantity</label>
                    <input type="number" name="quantity" class="form-control"
                           min="0" required>
                </div>

            </div>

            <button type="submit" class="btn amazon-btn mt-3">Add Product</button>

        </form>

    </div>
</div>

<hr>

<!-- ================= PRODUCT MANAGEMENT TABLE ================ -->
<h3 class="mt-4 mb-3">Manage Products</h3>

<div class="d-flex mb-3">
    <a href="/admin/view_products_sorted" class="btn btn-sm amazon-btn me-2">
        <i class="bi bi-sort-up"></i> Sort by Price
    </a>

    <form method="GET" action="/admin/search_product" class="d-flex">
        <input type="text" name="query" class="form-control me-2"
               placeholder="Search product name" required>
        <button class="btn btn-sm amazon-btn">
            <i class="bi bi-search"></i> Search
        </button>
    </form>
</div>

<div class="table-responsive">
    <table class="table table-striped table-bordered align-middle shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Category</th>
                <th>Price ($)</th>
                <th>Qty</th>
                <th>Visible</th>
                <th>Actions</th>
            </tr>
        </thead>

        <tbody>
            {% for p in products %}
            <tr>
                <td>{{ p.id }}</td>
                <td>{{ p.name }}</td>
                <td>{{ p.category }}</td>
                <td>$ {{ "%.2f"|format(p.price) }}</td>
                <td>{{ p.quantity }}</td>

                <!-- Visibility Indicator -->
                <td>
                    {% if p.visible_to_customers %}
                        <span class="badge bg-success">Yes</span>
                    {% else %}
                        <span class="badge bg-danger">No</span>
                    {% endif %}
                </td>

                <td>

                    <!-- UPDATE PRODUCT -->
                    <div class="mb-2">
                        <form method="POST" action="/admin/update_product" class="d-flex gap-1">
                            <input type="hidden" name="product_id" value="{{ p.id }}">

                            <input type="text" name="name"
                                   class="form-control form-control-sm"
                                   value="{{ p.name }}" required>

                            <select name="category" class="form-select form-select-sm">
                                <option selected>{{ p.category }}</option>
                                <option value="Appliances">Appliances</option>
                                <option value="Beauty">Beauty</option>
                                <option value="Computers">Computers</option>
                                <option value="Electronics">Electronics</option>
                                <option value="Furniture">Furniture</option>
                                <option value="Health & Personal Care">Health & Personal Care</option>
                                <option value="Home & Kitchen">Home & Kitchen</option>
                                <option value="Toys">Toys</option>
                            </select>

                            <input type="number" name="price" class="form-control form-control-sm"
                                   min="0" step="0.01" value="{{ p.price }}">

                            <input type="number" name="quantity" class="form-control form-control-sm"
                                   min="0" value="{{ p.quantity }}">

                            <button class="btn btn-sm btn-warning">
                                <i class="bi bi-arrow-repeat"></i>
                            </button>
                        </form>
                    </div>

                    <!-- DELETE PRODUCT -->
                    <div>
                        <form method="POST" action="/admin/delete_product">
                            <input type="hidden" name="product_id" value="{{ p.id }}">
                            <input type="hidden" name="confirm" value="no">

                            <button type="submit" class="btn btn-sm btn-danger"
                                    onclick="this.form.confirm.value='yes'; return confirm('Delete {{ p.name }}?');">
                                <i class="bi bi-trash"></i>
                            </button>
                        </form>
                    </div>

                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Orders Link -->
<a href="/admin/view_orders" class="btn amazon-btn mt-4">
    <i class="bi bi-card-checklist"></i> View All Orders
</a>

<!-- ========= AUTO CATEGORY SCRIPT ========== -->
<script>
const categoryKeywords = {
    "Appliances": ["fridge", "microwave", "oven", "dryer"],
    "Beauty": ["makeup", "skincare", "hair"],
    "Computers": ["laptop", "keyboard", "mouse"],
    "Electronics": ["tv", "phone", "camera", "speaker"],
    "Furniture": ["table", "chair", "sofa", "bed"],
    "Grocery & Household Essentials": ["milk", "bread", "soap"],
    "Health & Personal Care": ["vitamin", "medicine", "toothbrush"],
    "Home & Kitchen": ["plate", "blender", "pan"],
    "Home Improvement": ["paint", "drill", "hammer"],
    "Office Products": ["printer", "pen", "paper"],
    "Patio, Lawn & Garden": ["plant", "grill"],
    "Pet Supplies": ["cat", "dog", "leash"],
    "Sports & Fitness": ["ball", "bike", "mat"],
    "Toys": ["toy", "doll", "car"]
};

function autoSelectCategory() {
    let name = document.querySelector("input[name='name']").value.toLowerCase();
    let dropdown = document.getElementById("category");

    for (const [cat, keys] of Object.entries(categoryKeywords)) {
        for (const k of keys) {
            if (name.includes(k)) {
                dropdown.value = cat;
                return;
            }
        }
    }
}
</script>

{% endblock %}
